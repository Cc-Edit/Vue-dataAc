/*!
  * vue-dataAc v2.0.1
  * (c) 2020 adminV
  * @license MIT
  */
/*!
  * vue-dataAc v2.0.1
  * (c) 2020 adminV
  * @license MIT
  */
function t(t){return!(0===t&&"0"===t||void 0!==t&&null!=t&&"null"!==t&&""!==t)}function e(t){for(let e in t)return!1;return!0}function s(t){let e=t.attributes?t.attributes.length:0,s={};if(e>0)for(let r=0;r<e;r++){let e=t.attributes[r];s[e.nodeName]=e.nodeValue.replace(/"/gim,"'")}return s}function r(){let t=new Date;return{timeStr:`${t.getFullYear()}/${t.getMonth()+1}/${t.getDate()} ${t.getHours()}:${t.getMinutes()}:${t.getSeconds()}`,timeStamp:t.getTime()}}function o(t){const e=t.toString();let s=t.stack.replace(/\n/gi,"").replace(/\bat\b/gi,"@").replace(/\?[^:]+/gi,"").replace(/^\s*|\s*$/g,"").split("@").slice(0,5).join("&&");return s.indexOf(e)<0&&(s=e+"@"+s),s}const a={storeVer:"2.0.1",storeInput:"ACINPUT",storePage:"ACPAGE",storeClick:"ACCLIK",storeReqErr:"ACRERR",storeTiming:"ACTIME",storeCodeErr:"ACCERR",storeCustom:"ACCUSTOM",storeSourceErr:"ACSCERR",storePrmseErr:"ACPRERR",storeCompErr:"ACCOMP",storeVueErr:"ACVUERR",userSha:"vue_ac_userSha",useImgSend:!0,useStorage:!0,maxDays:365,openInput:!0,openCodeErr:!0,openClick:!0,openXhrData:!0,openXhrHock:!0,openPerformance:!0,openPage:!0,openVueErr:!0,openSourceErr:!0,openPromiseErr:!0,openComponent:!0,openXhrTimeOut:!0,maxRequestTime:1e4,customXhrErrCode:"0000",selector:"input",acRange:["text","tel","password"],classTag:"",acbLength:2,imageUrl:"http://open.isjs.cn/admin/ac.png",postUrl:"http://open.isjs.cn/logStash/push",openReducer:!1,sizeLimit:20,lifeReport:!1,manualReport:!1};let i;class n{constructor(s={},r={}){let o=function(t,e){let s,r={};const o=Object.keys(e);for(let a=0;a<o.length;a++)s=o[a],r[s]=void 0!==t[s]?t[s]:e[s];return r}(s,a);!function(s){if(e(s))return;["storeInput","storePage","storeClick","storeReqErr","storeTiming","storeCodeErr","userSha","useImgSend","useStorage","maxDays","openInput","openCodeErr","openClick","openXhrData","openXhrHock","openPerformance","openPage"].map(e=>{t(s[e])}),s.useImgSend?t(s.imageUrl):t(s.postUrl),s.openInput&&(t(s.selector),t(s.acRange)),s.useStorage}(o),this._options=o,this._vue_=r,i=this,this._uuid=function(t,e){if(!e)return null;if(t.useStorage)return window.localStorage.getItem(e);{let t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]*)(;|$)"));return t&&t.length>1?decodeURIComponent(t[2]):null}}(this._options,this._options.userSha),t(this._uuid)&&(this._uuid=function(t=16,e=16){let s,r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),o=[];for(s=0;s<t;s++)o[s]=r[0|Math.random()*e];return o.join("")}(),function(t,e,s,r){if(t.useStorage)window.localStorage.setItem(e,s);else{r||(r=t.maxDays);let o=new Date;o.setTime(o.getTime()+24*r*60*6e4),document.cookie=`${e}=${encodeURIComponent(s)};expires=${o.toUTCString()};path=/`}}(this._options,this._options.userSha,this._uuid)),this._acData=[],this._proxyXhrObj={},this._inputCacheData={},this._lastRouterStr="",this._userToken="",this._pageInTime=0,this._componentCount=0,this._init()}_init(){this._options.openVueErr&&this._initVueErrAc(),this._options.openCodeErr&&this._initCodeErrAc(),this._options.openSourceErr&&this._initSourceErrAc(),this._options.openPromiseErr&&this._initPromiseErrAc(),this._options.openClick&&this._initClickAc(),this._options.openXhrData&&this._initXhrErrAc(),this._options.openPerformance&&this._initPerformance()}_mixinMounted(t){let{acRange:e,selector:s}=this._options,r=document.querySelectorAll(s);for(let t=0,s=r.length;t<s;t++){let s=r[t];s.type&&e.indexOf(s.type.toLowerCase())>-1&&(s.removeEventListener("input",this._formatInputEvent),s.removeEventListener("blur",this._formatBlurEvent),s.addEventListener("input",this._formatInputEvent),s.addEventListener("blur",this._formatBlurEvent))}}_formatInputEvent(o){let a=window.event||o,n=a.srcElement?a.srcElement:a.target,{id:p,className:c,value:u,innerText:h}=n,l=s(n),m=u||h,_=r().timeStamp,d="";try{d=JSON.stringify(l)}catch(o){d=`${p}-${c}`}let g=i._inputCacheData[d];g=t(g)||e(g)?{value:"0:"+m,timeStamp:_}:{value:`${g.value},${parseInt(_-g.timeStamp)}:${m}`,timeStamp:_},i._inputCacheData[d]=g}_formatBlurEvent(e){let r=window.event||e,o=r.srcElement?r.srcElement:r.target,{id:a,className:n}=o,p=s(o),c="";try{c=JSON.stringify(p)}catch(e){c=`${a}-${n}`}let u=i._inputCacheData[c];t(u)||(i._inputCacheData[c]=null,i._setAcData(i._options.storeInput,{eId:a,className:n,val:u.value,attrs:p}))}_mixinRouterWatch(s={},r={}){let o=s.fullPath||s.path||s.name,a=e(s.params)?s.query:s.params,i=r.fullPath||r.path||r.name,n=e(r.params)?r.query:r.params;this._lastRouterStr!==`${o}-${JSON.stringify(a)}`&&(t(o)||t(i)||(this._lastRouterStr=`${o}-${JSON.stringify(a)}`,this._setAcData(this._options.storePage,{toPath:o,toParams:a,fromPath:i,formParams:n})))}_initClickAc(){document.addEventListener("click",e=>{let r=window.event||e,o=r.srcElement?r.srcElement:r.target,{className:a,id:i,value:n,innerText:p}=o,{classTag:c}=this._options;if(!t(c)&&a.indexOf(c)<0)return;let u=s(o);this._setAcData(this._options.storeClick,{eId:i,className:a,val:(n||p).substr(0,20),attrs:u})})}_initXhrErrAc(){let t=XMLHttpRequest.prototype.open,e=XMLHttpRequest.prototype.send,s=XMLHttpRequest.onreadystatechange;this._proxyXhrObj={open:function(){return this._ac_method=(arguments[0]||[])[0],t&&t.apply(this,arguments)},send:function(){return this._ac_send_time=r().timeStamp,this._ac_post_data=(arguments[0]||[])[0]||"",this.addEventListener("error",(function(t){i._formatXhrErrorData(t.target)})),this.onreadystatechange=function(t){i._formatXhrErrorData(t.target),s&&s.apply(this,arguments)},e&&e.apply(this,arguments)}},XMLHttpRequest.prototype.open=this._proxyXhrObj.open,XMLHttpRequest.prototype.send=this._proxyXhrObj.send}_formatXhrErrorData(t){let e=t,{method:s,send_time:o=0,post_data:a={},readyState:n}=e;if(4===n){let{status:t,statusText:p,response:c,responseURL:u}=e,h=r().timeStamp,l=h-(o||h),{openXhrTimeOut:m,storeReqErr:_,customXhrErrCode:d,openXhrData:g}=i._options,f=l>i._options.maxRequestTime,E=!(t>=200&&t<208)&&0!==t&&302!==t,T=""+(c&&c.code)===d;(m&&f||E||T)&&i._setAcData(_,{responseURL:u,method:s,isHttpErr:E,isCustomErr:T,readyState:n,status:t,statusText:p,requestTime:l,response:(""+c).substr(0,100),query:g?a:""})}}_initPerformance(){}_initVueErrAc(){this._vue_&&this._vue_.config&&(this._vue_.config.errorHandler=(t={},e,s)=>{const r=e._isVue?e.$options&&e.$options.name||e.$options&&e.$options._componentTag:e.name,a=e._isVue&&e.$options&&e.$options.__file?e.$options&&e.$options.__file:"",i=e.$options&&e.$options.propsData;this._setAcData(this._options.storeVueErr,{componentName:r,fileName:a,propsData:i,info:s,msg:t.message||"",stack:o(t)})})}_initCodeErrAc(){window.onerror=(e,s,r,o,a)=>{if(t(s)&&"Script error."===e)return!1;let i={msg:e,line:r,col:o};i.col=o||window.event&&window.event.errorCharacter||0,setTimeout(()=>{if(a&&a.stack)i.err=a.stack.toString();else if(arguments.callee){let t=[],e=arguments.callee.caller,s=3;for(;e&&--s>0&&(t.push(e.toString()),e!==e.caller);)e=e.caller;t=t.join(","),i.err=t}else i.err="script err";this._setAcData(this._options.storeCodeErr,i)},0)}}_initSourceErrAc(){window.addEventListener("error",e=>{if("[object Event]"===[].toString.call(e,e)){let s=e.target||e.srcElement||e.originalTarget||{},{tagName:r,outerHTML:o="",href:a,src:i,currentSrc:n,localName:p}=s;r=r||p;let c=a||i;if("IMG"===r&&!t(s.onerror))return!1;o&&o.length>200&&(o=o.slice(0,200)),this._setAcData(this._options.storeSourceErr,{tagName:r,outerHTML:o,resourceUri:c,currentSrc:n})}})}_initPromiseErrAc(){window.addEventListener("unhandledrejection",t=>{this._setAcData(this._options.storePrmseErr,{reason:t.reason||"unknown"}),t.preventDefault()})}_setAcData(t,e){let s={uuid:this._uuid,t:this._userToken};switch(t){case this._options.storePage:{let{toPath:t,toParams:o,fromPath:a,formParams:i}=e,n=this._pageInTime,p=r().timeStamp;this._pageInTime=p,s.acData={type:this._options.storePage,sTme:p,fromPath:a,formParams:i,toPath:t,toParams:o,inTime:n,outTime:p}}break;case this._options.storeInput:{let{eId:t,className:o,val:a,attrs:i}=e;s.acData={type:this._options.storeInput,path:window.location.href,sTme:r().timeStamp,ua:navigator.userAgent,eId:t,className:o,val:a,attrs:i}}break;case this._options.storeClick:{let{eId:t,className:o,val:a,attrs:i}=e;s.acData={type:this._options.storeClick,path:window.location.href,sTme:r().timeStamp,ua:navigator.userAgent,eId:t,className:o,val:a,attrs:i}}break;case this._options.storeReqErr:{let{responseURL:t,method:o,isHttpErr:a,isCustomErr:i,readyState:n,status:p,statusText:c,requestTime:u,response:h,query:l}=e;s.acData={type:this._options.storeReqErr,path:window.location.href,sTme:r().timeStamp,ua:navigator.userAgent,errSubType:a?"http":i?"custom":"time",responseURL:t,method:o,readyState:n,status:p,statusText:c,requestTime:u,response:h,query:l}}break;case this._options.storeVueErr:{let{componentName:t,fileName:o,propsData:a,info:i,msg:n,stack:p}=e;s.acData={type:this._options.storeVueErr,path:window.location.href,sTme:r().timeStamp,ua:navigator.userAgent,componentName:t,fileName:o,propsData:a,info:i,msg:n,err:p}}break;case this._options.storeCodeErr:{let{msg:t,line:o,col:a,err:i}=e;s.acData={type:this._options.storeCodeErr,path:window.location.href,sTme:r().timeStamp,ua:navigator.userAgent,msg:t,line:o,col:a,err:i}}break;case this._options.storeSourceErr:{let{tagName:t,outerHTML:o,resourceUri:a,currentSrc:i}=e;s.acData={type:this._options.storeSourceErr,path:window.location.href,sTme:r().timeStamp,ua:navigator.userAgent,fileName:i,resourceUri:a,tagName:t,outerHTML:o}}break;case this._options.storePrmseErr:{let{reason:t}=e;s.acData={type:this._options.storePrmseErr,path:window.location.href,sTme:r().timeStamp,ua:navigator.userAgent,reason:t}}break;case this._options.storeCustom:{let{cusKey:t,cusVal:o}=e;s.acData={type:this._options.storeCustom,path:window.location.href,sTme:r().timeStamp,ua:navigator.userAgent,cusKey:t,cusVal:o}}break;case this._options.storeTiming:}this._acData.push(s),this._options.openReducer?!this._options.manualReport&&this._options.sizeLimit&&this._acData.length>=this._options.sizeLimit&&(this._vue_&&this._vue_.$nextTick?this._vue_.$nextTick(()=>{this.postAcData()}):this.postAcData()):this._vue_&&this._vue_.$nextTick?this._vue_.$nextTick(()=>{this.postAcData()}):this.postAcData()}setCustomAc(t){let{cusKey:e="custom",cusVal:s=""}=t;this._setAcData(this._options.storeCustom,{cusKey:e,cusVal:s})}postAcData(){if(t(this._acData)||0===this._acData.length)return;let e=JSON.stringify(this._acData);this._options.useImgSend?(new Image).src=`${this._options.imageUrl}?acError=${e}`:function(t={}){let e,s;t.type=(t.type||"GET").toUpperCase(),t.dataType=t.dataType||"json",t.async=t.async||!0,t.data&&(s=t.data),window.XMLHttpRequest?(e=new XMLHttpRequest,e.overrideMimeType&&e.overrideMimeType("text/xml")):e=new ActiveXObject("Microsoft.XMLHTTP"),"GET"===t.type?(e.open("GET",t.url+"?"+s,t.async),e.send(null)):"POST"===t.type&&(e.open("POST",t.url,t.async),e.setRequestHeader("Content-Type","application/json; charset=UTF-8"),s?e.send(s):e.send())}({type:"POST",dataType:"json",contentType:"application/json",data:e,url:this._options.postUrl}),this._acData=[]}setUserToken(t){this._userToken=t}}n.install=(t,e)=>function t(e,s,r){t.installed||(t.installed=!0,e.mixin({watch:{$route(t,e){this.$vueDataAc&&this.$vueDataAc._mixinRouterWatch(t,e)}},mounted(){this.$vueDataAc._componentCount++,this.$vueDataAc&&this.$vueDataAc._options.openInput&&this.$nextTick((function(){0==--this.$vueDataAc._componentCount&&this.$vueDataAc._mixinMounted(this)}))}}),e.prototype.$vueDataAc=new r(s,e))}(t,e,n),n.version="2.0.1";export default n;